# 技術アーキテクチャ

## 1. 基本構成

本プロジェクトは、特別なサーバーサイドやビルド環境を必要としない、シンプルなフロントエンド技術のみで構成する。

- **実行環境:** モダンブラウザ (Google Chrome, Firefox, Safari, Edge)
- **主要言語:** HTML, CSS, JavaScript (ES6+)

## 2. 主要ライブラリ・フレームワーク

| 役割               | 技術             | 選定理由                                                                                                                                                 |
| ------------------ | ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **3Dレンダリング** | **Three.js**     | Web 3Dのデファクトスタンダードであり、豊富なドキュメントとコミュニティを持つ。AIによるコード生成においても、学習データが豊富で安定した出力を期待できる。 |
| **物理演算**       | **自前実装**     | 現在はライブラリに頼らず、自前の簡易的な当たり判定と重力計算を実装している。                                                                             |
| **UI**             | **素のHTML/CSS** | 素のHTML/CSSとDOM操作でUIを構築している。                                                                                                                |

## 3. ディレクトリ構成（src）

開発を進めるにあたり、`src`フォルダ内を機能ごとに分割して管理する。

```text
src/
├── main.js           # ゲームのメインループ、全体管理
├── core/
│   ├── game.js         # ゲームのメインクラス
│   ├── sceneManager.js # シーン（舞台）の管理
│   ├── assetLoader.js  # アセットの読み込み
│   └── components/     # 再利用可能なコンポーネント
│       └── physics-component.js # 物理演算コンポーネント
├── entities/
│   ├── character.js    # 全キャラクターのベースクラス（物理、HP、アニメーション管理）
│   ├── player.js       # プレイヤー
│   ├── enemy.js        # 敵キャラクター
│   └── npc.js          # NPC
├── world/
│   ├── field.js        # 地形や背景の生成
│   └── light.js        # ライトの設定
│   ├── item.js         # アイテム
│   └── projectile.js   # プロジェクタイル
├── controls/
│   └── input-controller.js # キーボード・マウス入力、およびカメラの管理
├── ui/
│   └── hud.js          # 画面表示（HPゲージなど）
├── utils/
│   └── constants.js    # 定数管理
└── public/data/      # ゲームデータ（JSONファイル）
    ├── player.json
    ├── weapons.json
    ├── enemies.json
    ├── npcs.json
    ├── items.json
    └── skills.json
```

## 4. データ駆動アーキテクチャ

ゲームの各種パラメータ（プレイヤーのステータス、武器の性能、敵のHPなど）は、コードから分離し、`public/data` ディレクトリ内のJSONファイルとして管理する「データ駆動型アーキテクチャ」を採用する。
これにより、ゲームバランスの調整やコンテンツの追加を、コードの変更なしにデータファイルの編集のみで柔軟に行える。

- **データ形式:** JSON (JavaScript Object Notation)
- **読み込み:** ゲーム起動時に `AssetLoader` がすべてのJSONデータを非同期で読み込み、`game.data` オブジェクトに格納する。
- **アクセス:** 各クラスは `this.game.data` を通じて、必要なパラメータにアクセスする。

## 5. アセット管理

- **3Dモデル/テクスチャ:** 当初はThree.jsのプリミティブ形状（`BoxGeometry`, `SphereGeometry`など）と基本的なマテリアル（`MeshStandardMaterial`など）で全てを表現する。ロゴ画像も追加する。
- **サウンド:** フリー素材サイトなどを活用し、必要に応じて追加する。タイトルBGMも追加する。

## 6. コーディング規約

- **スタイル:** [Prettier](https://prettier.io/) のデフォルト設定に準拠する。
- **命名規則:**
  - ファイル名: `kebab-case` (例: `input-controller.js`)
  - クラス名: `PascalCase` (例: `InputController`)
  - 関数・変数名: `camelCase` (例: `handleClick`)
- **モジュール:** ES Modules (`import`/`export`) を使用する。

## 7. アニメーションシステム

本プロジェクトのアニメーションは、状態ベースとイベント駆動を組み合わせたハイブリッドなアプローチを採用している。

- **`Character.js`:**
  - `THREE.AnimationMixer`を保持し、アニメーションの再生、切り替え（クロスフェード）、ループ設定を管理する責務を持つ。
  - `playAnimation`メソッドは、指定されたアニメーションクリップを再生するための汎用的なインターフェースを提供する。

- **`Player.js` (`updateAnimation`メソッド):**
  - 継続的な状態（待機、歩行、ダッシュ、ジャンプなど）を管理する。
  - `update`ループ内でプレイヤーの現在の速度や状態フラグを評価し、適切なループアニメーションを`playAnimation`メソッドを介してリクエストする。

- **`InputController.js`:**
  - 攻撃やローリングといった、プレイヤーの入力に直接起因する一回再生のアクション（イベント）を管理する。
  - マウスクリックやキープレスを検知した際に、直接`player.playAnimation`を呼び出し、即座にアクションアニメーションをトリガーする。

- **`Player.js` (イベントリスナー):**
  - `AnimationMixer`の`finished`イベントをリッスンする。
  - 一回再生のアニメーション（攻撃など）が完了したことを検知し、キャラクターの状態フラグ（例: `isAttacking`）をリセットする。これにより、キャラクターは次の行動（待機や歩行など）にスムーズに移行できる。

この設計により、継続的な状態と瞬間的なアクションを明確に分離し、複雑な状況下でも堅牢で自然なアニメーション遷移を実現している。
